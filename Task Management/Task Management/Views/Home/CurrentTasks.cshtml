@{
    ViewData["Title"] = "Current Tasks";
    var today = DateTime.Now.ToString("yyyy-MM-dd");
    var nextYear = DateTime.Now.AddYears(1).ToString("yyyy-MM-dd");
}
<style>

    .task-info-input {
        display: flex;
        align-items: center;
        gap: 50px;
        margin: 40px 0px 10px 20px;
    }

    #input-field-name,
    #input-field-description,
    #input-deadline-date {
        margin: 0;
        width: 500px;
        font-size: 25px;
        padding: 10px;
        border: 1px solid #ccc; 
        border-radius: 4px;
        background-color: #f9f9f9;
    }

    #input-field-description {
        width: 800px;
        height: 130px;
    }

    .radio-group {
        display: flex;
        gap: 30px;
        align-items: center;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 22px;
        cursor: pointer;
    }

    .radio-option input[type="radio"] {
        width: 22px;
        height: 22px;
        cursor: pointer;
        accent-color: #333;
    }

    .priority-high {
        color: red;
    }

    .priority-medium {
        color: orange;
    }

    .priority-low {
        color: green;
    }

    .priority-critical {
        color: darkred;
    }

    .status-working {
        color: blue;
    }

    .status-pending {
        color: orange;
    }

    .status-completed {
        color: green;
    }

    .status-abandoned {
        color: red; 
    }

    .submit-button{
        margin:20px;
        width:180px;
        height:50px;
        border:solid 2px black;
        background-color: #9370DB;
        font-size:20px;
        border-radius:5px;
        color:white;
    }

    #tasks-table {
        border-collapse: collapse;
        width: 100%;
    }

    #tasks-table th,#tasks-table td {
            border: 4px solid #9370DB;
            font-size:20px;
            padding: 8px;
            text-align: left;
    }

    .edit-modal{
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }
</style>
<div id="task-form">
    <div class="main-block">
        <div class="task-info-input">
            <h2>Task Name</h2>
            <input type="text" id="input-field-name" placeholder="Enter task name" required />
        </div>

        <div class="task-info-input">
            <h2>Task Description</h2>
            <textarea id="input-field-description" placeholder="Enter task description" required></textarea>
        </div>

        <div class="task-info-input">
            <h2>Deadline Date</h2>
            <input type="date" id="input-deadline-date" required
                   min="@today" max="@nextYear" />
        </div>

        <div class="task-info-input">
            <h2>Priority</h2>
            <div class="radio-group">
                <label class="radio-option priority-low">
                    <input type="radio" name="priorityId" value="1" required /> Low
                </label>
                <label class="radio-option priority-medium">
                    <input type="radio" name="priorityId" value="2" /> Medium
                </label>
                <label class="radio-option priority-high">
                    <input type="radio" name="priorityId" value="3" /> High
                </label>
                <label class="radio-option priority-critical">
                    <input type="radio" name="priorityId" value="4" /> Critical
                </label>
            </div>
        </div>

        <div class="task-info-input">
            <h2>Status</h2>
            <div class="radio-group">
                <label class="radio-option status-working">
                    <input type="radio" name="statusId" value="1" required checked /> In Progress
                </label>
                <label class="radio-option status-pending">
                    <input type="radio" name="statusId" value="2" /> Pending
                </label>
                <label class="radio-option status-abandoned">
                    <input type="radio" name="statusId" value="4" /> Abandoned
                </label>
            </div>
        </div>
        <button class="submit-button" type="button" onclick="createTask()">Add task</button>
    </div>
    <div id="tasks-table-container" style="margin-top: 40px;">
        <h2>Current Tasks</h2>
        <table id="tasks-table" border="1" cellpadding="8" cellspacing="0" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>Task Name</th>
                    <th>Task Description</th>
                    <th>Deadline Date</th>
                    <th>Date Added</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Completed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tasks-tbody">
            </tbody>
        </table>
</div>
<div class="edit-modal" id="edit-modal">
    <div style="background:white; margin:50px auto; padding:20px; width:500px;border-radius:8px;">
        <h3>Edit Task</h3>
        <input type="hidden" id="edit-task-id">
        <input type="text" id="edit-task-name" placeholder="Task Name" style="width:100%; margin:5px 0px 5px"><br>
            <textarea id="edit-task-desc" placeholder="Description" style="width:100%; height:100px; margin:5px 0px 5px;"></textarea><br>
            <input type="date" id="edit-deadline" style="margin:5px 0px 10px;"><br>
            <button onclick="saveTask()" style="border-radius:5px;background-color:#32CD32">Save</button>
            <button onclick="closeEdit()" style="border-radius:5px;background-color:#B22222">Cancel</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', loadTasks);
async function loadTasks() {
    try {
        const response = await fetch('/api/Api/GetTasks');
        const tasks = await response.json();
        renderTasks(tasks);
    } catch (error) {
        console.error('Error loading tasks:', error);
    }
}

function renderTasks(tasks) {
    const tbody = document.getElementById('tasks-tbody');
    tbody.innerHTML = '';
    tasks.forEach(task => {
        const row = document.createElement('tr');
        const priorityText = getPriorityText(task.priorityid);
        const statusText = getStatusText(task.statusid);
        row.innerHTML = `
            <td>${task.task_name || ''}</td>
            <td>${task.task_description || ''}</td>
            <td>${task.deadlinedate || ''}</td>
            <td>${task.dateadded || ''}</td>
            <td>${priorityText}</td>
            <td>${statusText}</td>
            <td>${task.iscompleted ? 'Yes' : 'No'}</td>
            <td>
                <button class="update-btn edit-btn" style="background-color:white;border-radius:5px;" onclick="editTask(${task.task_id})">🖊</button>
                <button class="complete-btn"style="background-color:white;border-radius:5px;" onclick="completeTask(${task.task_id})">✅</button>
                <button class="delete-btn" style="background-color:white;border-radius:5px;" onclick="deleteTask(${task.task_id})">🗑️</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

async function createTask() {
    const taskData = {
        task_name: document.getElementById('input-field-name').value,
        task_description: document.getElementById('input-field-description').value,
        deadlinedate: document.getElementById('input-deadline-date').value,
        dateadded: new Date().toISOString().split('T')[0],
        priorityid: document.querySelector('input[name="priorityId"]:checked').value,
        statusid: document.querySelector('input[name="statusId"]:checked').value,
        iscompleted: false
    };

    try {
        const response = await fetch('/api/Api/CreateTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(taskData)
        });

        if (response.ok) {
            alert('Task added!');
            loadTasks();
            document.getElementById('input-field-name').value = '';
            document.getElementById('input-field-description').value = '';
        } else {
            const error = await response.text();
            alert('Error: ' + error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function editTask(taskId) {
    try {
        const response = await fetch('/api/Api/GetTasks');
        const tasks = await response.json();
        const task = tasks.find(t => t.task_id === taskId);
        if (task) {
            document.getElementById('edit-task-id').value = taskId;
            document.getElementById('edit-task-name').value = task.task_name || '';
            document.getElementById('edit-task-desc').value = task.task_description || '';
            document.getElementById('edit-deadline').value = task.deadlinedate || '';
            document.getElementById('edit-modal').style.display = 'block';
        }
    } catch (error) {
        alert('Error loading task: ' + error.message);
    }
}

async function saveTask() {
    const taskId = document.getElementById('edit-task-id').value;
    const taskData = {
        task_id: parseInt(taskId),
        task_name: document.getElementById('edit-task-name').value,
        task_description: document.getElementById('edit-task-desc').value,
        deadlinedate: document.getElementById('edit-deadline').value,
        dateadded: new Date().toISOString().split('T')[0],
        priorityid: 1,
        statusid: 1,
        iscompleted: false
    };

    try {
        const response = await fetch('/api/Api/UpdateTask', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(taskData)
        });

        if (response.ok) {
            alert('Task updated!');
            closeEdit();
            loadTasks();
        } else {
            const error = await response.text();
            alert('Error: ' + error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function closeEdit() {
    document.getElementById('edit-modal').style.display = 'none';
}

async function completeTask(taskId) {
            if (!confirm('Was the task completed?')) return;

    try {
        const response = await fetch('/api/Api/GetTasks');
        const tasks = await response.json();
        const task = tasks.find(t => t.task_id === taskId);

        if (task) {
            const taskData = {
                task_id: taskId,
                task_name: task.task_name,
                task_description: task.task_description,
                deadlinedate: task.deadlinedate,
                dateadded: task.dateadded,
                priorityid: task.priorityid,
                statusid: 3,
                iscompleted: true
            };

            const updateResponse = await fetch('/api/Api/UpdateTask', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
            });

            if (updateResponse.ok) {
                await fetch('/api/Api/ArchiveTasks',{
                    method:'POST'
                });

                alert('Task completed!');
                loadTasks();
                window.location.href='/Home/Archive'
            }
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteTask(taskId) {
    if (!confirm('Delete this task?')) return;

    try {
        const response = await fetch(`/api/Api/DeleteTask/${taskId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('Task deleted!');
            loadTasks();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function getPriorityText(id) {
    const priorities = {1: 'Low', 2: 'Medium', 3: 'High', 4: 'Critical'};
    return priorities[id] || 'Unknown';
}

function getStatusText(id) {
    const statuses = {1: 'In Progress', 2: 'Pending', 3: 'Completed', 4: 'Abandoned'};
    return statuses[id] || 'Unknown';
}
</script>
